"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){function o(n,s){try{var i=r[n](s),a=i.value}catch(e){return void t(e)}if(!i.done)return Promise.resolve(a).then(function(e){o("next",e)},function(e){o("throw",e)});e(a)}return o("next")})}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.start=void 0;var initServer=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var o,n,s,i,a,u,c,p,l;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:for(e.prev=0,o=new _koa2.default,o.context.conf=r,n=0,s=t.moduleList.length;n<s;n++)i=t.moduleList[n],o.use(i.hash.applyRouter(o).routes());a=_http2.default.Server(o.callback()),o.server=a,u=0,c=t.moduleList.length;case 7:if(!(u<c)){e.next=15;break}if(p=t.moduleList[u],"function"!=typeof p.hash.beforeStart){e.next=12;break}return e.next=12,p.hash.beforeStart(a,o);case 12:u++,e.next=7;break;case 15:l=r.defaults.port,a.listen(l,function(){var e="http://localhost:"+l,r="http://"+(0,_utils.getIPv4IPAddress)()+":"+l;_utils.colorconsole.info("### App Server ### 服务器地址: "+e+", "+r),_utils.colorconsole.info("### App Server ### 请确保手机与App Server处于相同网段"),(0,_utils.outputQRCodeOnTerminal)(r)}),o.on("error",function(e,r){_utils.colorconsole.error("### App Server ### 服务器错误: "+e.message);var t="出错了!HTTP error code: "+e.status+", 出错信息: "+e.message;r&&(r.body=t)}),a.on("error",function(e){_utils.colorconsole.error("### App Server ### 服务器错误: "+e.message),"EADDRINUSE"===e.code&&_utils.colorconsole.error("### App Server ### 服务器错误:端口 "+l+" 被占用, 请检查")}),process.on("SIGINT",function(){_utils.colorconsole.info("### App Server ### SIGINT信号"),_utils.colorconsole.info("### App Server ### 退出server进程 pid: "+process.pid),process.exit()}),process.on("uncaughtException",function(e){_utils.colorconsole.error("### App Server ### 未定义的异常, 出错信息: "+e.message)}),e.next=26;break;case 23:e.prev=23,e.t0=e.catch(0),_utils.colorconsole.error("### App Server ### 服务器启动失败: "+e.t0.message);case 26:case"end":return e.stop()}},e,this,[[0,23]])}));return function(r,t){return e.apply(this,arguments)}}(),initOptions=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:o=r.options.watch,o&&(0,_watch.startWatcher)(r,t);case 2:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),start=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:initServer(r,t),initOptions(r,t);case 2:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),_http=require("http"),_http2=_interopRequireDefault(_http),_koa=require("koa"),_koa2=_interopRequireDefault(_koa),_watch=require("./command/watch"),_utils=require("./lib/utils");exports.start=start;