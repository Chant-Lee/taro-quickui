"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function ZipPlugin(e){this.options=e}function copyfile(e,i,t){if(_fs2.default.existsSync(e)){if(/.+\.9\.png$/.test(_path2.default.basename(e))){var s=_path2.default.isAbsolute(i)?i:_path2.default.join(projDir,i);_aaptjs2.default.singleCrunch(e,s,function(s){s&&_utils.colorconsole.log("### App Loader ### 资源文件 ${srcpath}, 转换失败: "+s),t(e,i)})}else{var a=_fs2.default.createReadStream(e),r=_fs2.default.createWriteStream(i);a.pipe(r),a.on("close",function(){r.end(),t(e,i)})}}}function parse(e,i,t,s){i=i||".";var a=_path2.default.posix.join(e,i),r=void 0;s.readdirSync(a).forEach(function(n){var o=_path2.default.posix.join(a,n),l=s.statSync(o);if(l.isFile()){var u=i.split(_path2.default.sep).join(_path2.default.posix.sep);r=_path2.default.posix.join(u,_path2.default.basename(n)),t(r,o)}else if(l.isDirectory()){var f=_path2.default.posix.join(i,n);parse(e,f,t,s)}})}function removeWebpackCode(e,i){return/\.js$/.test(e)?(/app\.js$/.test(e)&&(i=i.replace(/\n\W__webpack_require__\(\d+\);\n/,"\n")),i):i}var _fs=require("fs"),_fs2=_interopRequireDefault(_fs),_path=require("path"),_path2=_interopRequireDefault(_path),_jszip=require("jszip"),_jszip2=_interopRequireDefault(_jszip),_aaptjs=require("aaptjs"),_aaptjs2=_interopRequireDefault(_aaptjs),_bundle=require("./bundle"),_bundle2=_interopRequireDefault(_bundle),_child_process=require("child_process"),_child_process2=_interopRequireDefault(_child_process),_utils=require("./utils"),_shared=require("./shared"),exec=_child_process2.default.exec,projDir=process.cwd(),signFiles={debug:{privatekey:_path2.default.join(projDir,"sign/debug/private.pem"),certificate:_path2.default.join(projDir,"sign/debug/certificate.pem")},release:{privatekey:_path2.default.join(projDir,"sign/release/private.pem"),certificate:_path2.default.join(projDir,"sign/release/certificate.pem")}};ZipPlugin.prototype.apply=function(e){var i=this.options;e.plugin("watch-run",function(e,i){Object.keys(this.options.entry).forEach(function(e){var i=this.options.entry[e];i instanceof Array&&!/app\.js/.test(e)&&-1!==i[0].indexOf("webpack-dev-server")&&i.shift()}.bind(this)),i()}),e.plugin("done",function(){var e=this.outputFileSystem,t=i.sign;if(!1===t?signFiles.mode=signFiles.debug:!0===t&&(signFiles.mode=signFiles.release),signFiles.mode&&!_fs2.default.existsSync(signFiles.mode.privatekey))return void _utils.colorconsole.log("### App Loader ### 缺少私钥文件, 打包失败: "+signFiles.mode.privatekey);if(signFiles.mode&&!_fs2.default.existsSync(signFiles.mode.certificate))return void _utils.colorconsole.log("### App Loader ### 缺少证书文件, 打包失败: "+signFiles.mode.certificate);var s=i.res,a=Object.keys(s).length,r=function(s,r){if(/manifest\.json$/.test(r)&&(0,_shared.updateProjectManifest)(r,i),!(--a>0)){_utils.colorconsole.log("### App Loader ### 编译完成, 生成压缩包"),(0,_utils.mkdirsSync)(i.output);var n=[],o=_path2.default.join(i.output,"bundle."+(new Date).getTime()+".zip"),l=i.src;if(_fs2.default.existsSync(l)){var u=_fs2.default.createWriteStream(o),f=new _jszip2.default;u.on("finish",function(){if(signFiles.mode){_utils.colorconsole.log("### App Loader ### 压缩包加签名");var e=_path2.default.join(i.output,i.name+".rpk");t&&(e=e.replace(/\.rpk$/,".signed.rpk"));var s=_fs2.default.readFileSync(signFiles.mode.privatekey),a=_fs2.default.readFileSync(signFiles.mode.certificate);_bundle2.default.signZip({zip:o,files:n},s,a,e),_fs2.default.existsSync(o)&&_fs2.default.unlinkSync(o);var r=_path2.default.join(__dirname,"../../","server");exec("cd "+r+" && node ./command/notify.js",function(e,i,t){e?_utils.colorconsole.log("### App Loader ### 自动刷新执行build失败 :"+t):_utils.colorconsole.log("### App Loader ### 自动刷新执行build :"+i)})}}),e.readdirSync?(parse(l,".",function(i,t){var s=removeWebpackCode(t,e.readFileSync(t).toString());void 0!==s&&(n.push({name:Buffer.from(i),file:t,hash:_bundle2.default.hashFile(t,e)}),f.file(i,s))},e),parse(l,".",function(e,i){n.push({name:Buffer.from(e),file:i,hash:_bundle2.default.hashFile(i,_fs2.default)}),f.file(e,_fs2.default.createReadStream(i))},_fs2.default)):parse(l,".",function(e,i){n.push({name:Buffer.from(e),file:i,hash:_bundle2.default.hashFile(i,_fs2.default)}),f.file(e,_fs2.default.createReadStream(i))},_fs2.default);var p={compression:"DEFLATE",compressionOptions:{level:9}};f.generateNodeStream(p).pipe(u)}}};Object.keys(s).forEach(function(e){var i=s[e],t=_path2.default.dirname(e);(0,_utils.mkdirsSync)(t),_fs2.default.existsSync(t)?copyfile(i,e,r):(_fs2.default.mkdirSync(t),copyfile(i,e,r))})})},module.exports=ZipPlugin;