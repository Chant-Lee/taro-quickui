"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function makeLoaderString(e,r){r=r||{};var a=void 0;return"component"===e?(a=[{name:defaultLoaders.component,query:{type:"component"}}],(0,_utils.stringifyLoaders)(a)):"template"===e?(a=[{name:defaultLoaders.json},{name:defaultLoaders.template}],r.source||a.push({name:defaultLoaders.fragment,query:{index:0,type:"templates"}}),(0,_utils.stringifyLoaders)(a)):"style"===e?(a=[{name:defaultLoaders.json},{name:defaultLoaders.style,query:{index:0,type:"styles"}}],r.lang&&a.push({name:r.lang+"-loader"}),r.source||a.push({name:defaultLoaders.fragment,query:{index:0,type:"styles"}}),(0,_utils.stringifyLoaders)(a)):"script"===e?(a=[{name:defaultLoaders.script},{name:defaultLoaders.babel,query:{presets:[(0,_utils.loadBabelModule)("babel-preset-env")],plugins:[_path2.default.resolve(__dirname,"jsx-loader.js")],comments:"false"}},{name:defaultLoaders.access}],r.source||a.push({name:defaultLoaders.fragment,query:{index:0,type:"scripts"}}),(0,_utils.stringifyLoaders)(a)):void 0}function loader(e,r,a){var t=e;t.cacheable&&t.cacheable();var s=_loaderUtils2.default.parseQuery(t.resourceQuery),l=t.resourcePath,o=(_path2.default.relative(".",l),!a||"component"!==a.type),n=s.name||(0,_utils.getNameByPath)(l);_validator2.default.isReservedTag(n)&&(0,_utils.logWarn)(t,[{reason:"脚本文件名不能使用保留字:"+n}]),(0,_utils.print)({loaderQuery:a,resourceQuery:t.resourceQuery,resourcePath:t.resourcePath,name:n});var i=(0,_parser.parseFragment)(r);return(0,_utils.print)(i),parseImportList(t,i.import).then(function(){return assemble(t,i,n,o,l)})}function resolveImportItemSrc(e,r){return r.src?new Promise(function(a){e.resolve(e.context,r.src,function(e,t){return e?(r.isValid=!1,r.err=e,a(r)):(r.isValid=!0,r.srcPath=t,a(r))})}):(r.isValid=!1,Promise.resolve(r))}function parseImportList(e,r){return Promise.all(r.map(function(r){return resolveImportItemSrc(e,r)}))}function assemble(e,r,a,t,s){var l="",o=[];if(r.import.length)for(var n=0;n<r.import.length;n++){var i=r.import[n];if(!i.src)return(0,_utils.logWarn)(e,[{reason:"导入组件需要设置属性 `src` "}]),"";if(!i.isValid)return e.emitError("导入组件resolve 出错 "+i.err),"";i.src=i.srcPath,i.name||(i.name=(0,_utils.getNameByPath)(i.src)),i.name=i.name.toLowerCase(),_validator2.default.isReservedTag(i.name)&&(0,_utils.logWarn)(e,[{reason:"导入组件的属性 `name` 不能使用保留字: "+i.name}]),o.push(i.name);var p=i.src;(0,_utils.print)({name:i.name,src:i.src,rsrc:p});var u=(0,_utils.makeRequireString)(e,makeLoaderString("component",{source:i.src}),p+"?name="+i.name);l+=u}if(r.depends.length){var d={},m=!0,_=!1,c=void 0;try{for(var f,h=r.depends[Symbol.iterator]();!(m=(f=h.next()).done);m=!0){var v=f.value,g=_path2.default.resolve(_path2.default.dirname(s),""+v);d[v]=g,o.indexOf(v)<0&&_fs2.default.existsSync(g)&&(l+=(0,_utils.makeRequireString)(e,makeLoaderString("none"),"./"+v))}}catch(e){_=!0,c=e}finally{try{!m&&h.return&&h.return()}finally{if(_)throw c}}(0,_utils.print)(d)}if(!r.template.length)return(0,_utils.logWarn)(e,[{reason:"需要模板片段"}]),"";var y=r.template[0],$=s;if(y.src&&($=y.src),l+="var $app_template$ = "+(0,_utils.makeRequireString)(e,makeLoaderString("template",{source:y.src}),$),r.style.length){var q=r.style[0],L=s;q.src&&(L=q.src),l+="var $app_style$ = "+(0,_utils.makeRequireString)(e,makeLoaderString("style",{source:q.src,lang:q.lang}),L),(0,_utils.print)({style:L})}if(r.script.length){var P=r.script[0],x=s;P.src&&(x=P.src),l+="var $app_script$ = "+(0,_utils.makeRequireString)(e,makeLoaderString("script",{source:P.src}),x+"?isEntry="+t)}if(l+="\n$app_define$('@app-component/"+a+"', [], function($app_require$, $app_exports$, $app_module$){\n",r.script.length>0&&(l+="     $app_script$($app_module$, $app_exports$, $app_require$)\n",l+="     if ($app_exports$.__esModule && $app_exports$.default) {\n            $app_module$.exports = $app_exports$.default\n        }\n"),l+="     $app_module$.exports.template = $app_template$\n",r.style.length>0&&(l+="     $app_module$.exports.style = $app_style$\n"),l+="})\n",t){l+="\n$app_bootstrap$('@app-component/"+a+"',{ packagerVersion: '"+JSON.parse(_fs2.default.readFileSync(packagepath).toString()).subversion.packager+"'})\n"}return l}var _loaderUtils=require("loader-utils"),_loaderUtils2=_interopRequireDefault(_loaderUtils),_path=require("path"),_path2=_interopRequireDefault(_path),_fs=require("fs"),_fs2=_interopRequireDefault(_fs),_md=require("md5"),_md2=_interopRequireDefault(_md),_parser=require("./parser"),_utils=require("./utils"),_validator=require("./template/validator"),_validator2=_interopRequireDefault(_validator),loaderPath=__dirname,packagepath=_path2.default.resolve(loaderPath,"../package.json"),defaultLoaders={none:"",component:_path2.default.resolve(loaderPath,"loader.js"),fragment:_path2.default.resolve(loaderPath,"fragment-loader.js"),template:_path2.default.resolve(loaderPath,"template-loader.js"),style:_path2.default.resolve(loaderPath,"style-loader.js"),script:_path2.default.resolve(loaderPath,"script-loader.js"),access:_path2.default.resolve(loaderPath,"access-loader.js"),json:_path2.default.resolve(loaderPath,"json-loader.js"),babel:"babel-loader"};module.exports=loader;