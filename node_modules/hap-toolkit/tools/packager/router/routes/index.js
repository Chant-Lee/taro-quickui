"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){function n(a,o){try{var i=r[a](o),s=i.value}catch(e){return void t(e)}if(!i.done)return Promise.resolve(s).then(function(e){n("next",e)},function(e){n("throw",e)});e(s)}return n("next")})}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.logger=void 0;var index=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,a,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.app.server.address().port,a=(0,_service.getServerAddress)(n),o=_qrImage2.default.image(a,{size:9}),r.type="image/png",r.body=o,e.next=7,t();case 7:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),bundle=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,a,o,i,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=process.cwd(),a=(0,_service.getProjectName)(),o=_path2.default.join(n,"dist"),i=_path2.default.join(o,a+".rpk"),s=_path2.default.join(o,a+".signed.rpk"),_fs2.default.existsSync(i)?(r.body=_fs2.default.createReadStream(i),r.set("Content-Type","text/plain")):_fs2.default.existsSync(s)?(r.body=_fs2.default.createReadStream(s),r.set("Content-Type","text/plain")):(_utils.colorconsole.error("### App Server ### 项目dist目录下不存在rpk文件："+o),r.throw("404","无法找到项目的rpk文件")),e.next=8,t();case 8:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),logger=exports.logger=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,a,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=r.conf.defaults.pathClientLog,a=(0,_utils.getClientIPAddress)(r.req),o=(0,_utils.getIPv4IPAddress)(),a!==o&&(_utils.colorconsole.info("### App Server ### 记录从"+a+"进入的HTTP请求"),(0,_service.recordClientAddr)(n,a)),e.next=7,t();case 7:e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),_utils.colorconsole.error("### App Server ### 记录log出错: "+e.t0.message);case 12:case"end":return e.stop()}},e,this,[[0,9]])}));return function(r,t){return e.apply(this,arguments)}}(),qrCode=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,a,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.app.server.address().port,a=(0,_service.getServerAddress)(n),o=_qrImage2.default.image(a,{size:9}),e.next=5,t();case 5:r.type="image/png",r.body=o;case 7:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),_fs=require("fs"),_fs2=_interopRequireDefault(_fs),_path=require("path"),_path2=_interopRequireDefault(_path),_qrImage=require("qr-image"),_qrImage2=_interopRequireDefault(_qrImage),_utils=require("../lib/utils"),_service=require("../service");exports.default={index:index,bundle:bundle,qrCode:qrCode,logger:logger};