"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){function o(n,s){try{var a=r[n](s),i=a.value}catch(e){return void t(e)}if(!a.done)return Promise.resolve(i).then(function(e){o("next",e)},function(e){o("throw",e)});e(i)}return o("next")})}}function getInspectorUrl(e,r){var t=e.ws;return"http://"+getServerIPandPort(r.defaults.port)+"/inspector/inspector.html?ws="+encodeURI(t)+"&remoteFrontend=true&dockSide=undocked"}function untarInspectorTarFile(e){var r=e.inspectorTarFile,t=e.inspectorHtmlDir,o=!_fs2.default.existsSync(t),n=_fs2.default.existsSync(r);if(o)if(n&&o)_tar2.default.x({file:r,cwd:_path2.default.dirname(r)});else if(!n)throw new Error("缺少devtools inspector工程文件夹")}function printInspectorUrl(e){var r=e.request.body,t=r.ws,o=r.application,n=r.status,s=e.request.body["protocol-version"];emitWSEvent(e.io,"appRegistered",{ws:t,application:o,protocolVer:s,status:n});var a=getInspectorUrl({ws:t},e.conf);return _utils.colorconsole.info("### App Server ### 请访问以下链接进行调试：\n\n"+a+"\n"),a}function informToUpdateApk(e){_utils.colorconsole.warn("### App Server ### 调试器已有重要更新，请更新调试器"),e.io.sockets.emit("informUpdate",{})}function emitWSEvent(e,r,t){e.sockets.emit(r,t||{})}function replaceVarsOnIndexPage(e,r){var t=r.serverAddr;return new Promise(function(r,o){_fs2.default.readFile(e,"utf-8",function(e,n){if(e)return o(e);r(n.replace("{{server_ip}}",t))})})}function getServerIPandPort(e){return(0,_utils.getIPv4IPAddress)()+(80===e?"":":"+e)}function getChromePathCrossPlatform(){switch(process.platform){case"linux":return new Promise(function(e,r){(0,_child_process.exec)("which google-chrome",function(t,o,n){t&&r(t);var s=o.replace(/\n/g,"");return e(s)})});case"darwin":return new Promise(function(e,r){return e("/Applications/Google Chrome.app")});case"win32":return new Promise(function(e,r){(0,_child_process.exec)('REG QUERY "HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\App Paths\\chrome.exe" /v path',function(t,o,n){t&&r(t);var s=o,a=s.split("\n"),i=void 0;a.every(function(e){var r=e.match(/path\s+reg_sz\s+(.+)/i);return!r||(i=r[1],!1)});var c=i;return e(_path2.default.resolve(c,"chrome.exe"))})});default:return null}}function routerConf(e){return e.router.conf}Object.defineProperty(exports,"__esModule",{value:!0}),exports.startChromeProc=exports.prepareStartServer=void 0;var prepareStartServer=exports.prepareStartServer=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=routerConf(r.context),e.next=4,untarInspectorTarFile(t);case 4:e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),_utils.colorconsole.error("### App Server ### 解压inspector.tar.gz文件出错: "+e.t0.message);case 9:case"end":return e.stop()}},e,this,[[0,6]])}));return function(r){return e.apply(this,arguments)}}(),startChromeProc=exports.startChromeProc=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var o,n,s,a,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,_utils.colorconsole.info("### App Server ### 准备启动调试"),o=r.options.chromePath){e.next=7;break}return e.next=6,getChromePathCrossPlatform();case 6:o=e.sent;case 7:o&&_fs2.default.existsSync(o)||_utils.colorconsole.error("### App Server ### Chrome 路径不存在："+o),n="darwin"===process.platform,s=n?"open":_path2.default.resolve(o),a=n?[o,t]:[t],i=(0,_child_process.spawn)(s,a,{stdio:"ignore",detached:!0}),i.unref(),_utils.colorconsole.info("### App Server ### 已启动devtools调试页面"),e.next=19;break;case 16:e.prev=16,e.t0=e.catch(0),_utils.colorconsole.error("### App Server ### 启动chrome进程失败: "+e.t0.message);case 19:case"end":return e.stop()}},e,this,[[0,16]])}));return function(r,t){return e.apply(this,arguments)}}();exports.getInspectorUrl=getInspectorUrl,exports.untarInspectorTarFile=untarInspectorTarFile,exports.printInspectorUrl=printInspectorUrl,exports.informToUpdateApk=informToUpdateApk,exports.emitWSEvent=emitWSEvent,exports.replaceVarsOnIndexPage=replaceVarsOnIndexPage,exports.getServerIPandPort=getServerIPandPort,exports.getChromePathCrossPlatform=getChromePathCrossPlatform,exports.routerConf=routerConf;var _path=require("path"),_path2=_interopRequireDefault(_path),_fs=require("fs"),_fs2=_interopRequireDefault(_fs),_tar=require("tar"),_tar2=_interopRequireDefault(_tar),_child_process=require("child_process"),_utils=require("../lib/utils");